@using HomeSHS.Components.Helpers
@using SHC.Entities
@using SHC.Entities.Door
@using SHC.Entities.Light
@using SHC.Entities.Room
@using SHC.Entities.Window
@inject IJSRuntime JsRuntime
@inject IPageRefresher PageRefresher

<body>
    <div class="container">
        <svg id="render-container"
             width="1000"
             height="1000"
             viewBox="0 0 1000 1000">
            @foreach (var r in renderRooms)
            {
                <g>
                    <rect id="@(r.Item1.Name + "-" + r.Item1.Id)"
                          height="100"
                          width="100"
                          style="fill:white; stroke:black; stroke-width:2px"
                          x="@r.Item2.x"
                          y="@r.Item2.y"
                          @onclick=@(() => SetSelectedRoom(r.Item1))></rect>
                    <text id="@(r.Item1.Name + "-" + r.Item1.Id + "-text")"
                          class="@(simulationContext.SelectedRoom.Id == r.Item1.Id ? "text-selected" : "text-regular")"
                          x="@(r.Item2.x + 12)"
                          y="@(r.Item2.y + 50)"
                          @onclick=@(() => SetSelectedRoom(r.Item1))>
                        @r.Item1.Name
                    </text>
                    @if (AreLightsOn(r.Item1))
                    {
                        
                        <foreignObject x="@r.Item2.x" y="@(r.Item2.y + 100 - 20)" width="20" height="20">
                            <div xmlns="http://www.w3.org/1999/xhtml" style="font-size: 10px; color: yellow;">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                        </foreignObject>
                    }
                    else
                    {
                        <foreignObject x="@r.Item2.x" y="@(r.Item2.y + 100 - 20)" width="20" height="20">
                            <div xmlns="http://www.w3.org/1999/xhtml" style="font-size: 10px;">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                        </foreignObject>
                    }

                    @if (AreWindowsOpen(r.Item1))
                    {
                        
                        <image href="/asset/window-open.svg"
                               x="@r.Item2.x" y="@(r.Item2.y + 100 - 40)"
                               width="15" height="15" />
                    }
                    else
                    {
                        <image href="/asset/window-closed.svg"
                               x="@r.Item2.x" y="@(r.Item2.y + 100 - 40)"
                               width="15" height="15" />
                    }

                    @if (AreDoorsLocked(r.Item1))
                    {
                      
                        <image href="/asset/door-closed.svg"
                               x="@r.Item2.x" y="@(r.Item2.y)"
                               width="15" height="15" />
                    }
                    else
                    {
                        
                        <image href="/asset/door-open.svg"
                               x="@r.Item2.x" y="@(r.Item2.y)"
                               width="15" height="15" />
                    }
                  
                </g>
            }
        </svg>
    </div>
</body>


@code {
    SimulationContext simulationContext = SimulationContext.GetInstance();
    int rect1x = 0;
    int rect1y = 0;
    int rect2x = 100;
    int rect2y = 0;
    string showx = string.Empty;
    string showy = string.Empty;

    HouseAssembler houseAssembler = new HouseAssembler(); 
    House house;
    Entrance houseEntrance;
    List<(IRoom, (double x, double y))> renderRooms = new List<(IRoom, (double x, double y))>();

    protected override async Task OnInitializedAsync()
    {
        if (!simulationContext.hasRenderLoaded)
        {
            simulationContext.RenderRooms = await houseAssembler.BuildLayoutStructure();
            renderRooms = simulationContext.RenderRooms;
            simulationContext.SelectedRoom = renderRooms.FirstOrDefault().Item1;
            simulationContext.hasRenderLoaded = true;
        }
    }

    public void SetSelectedRoom(IRoom selectedRoom)
    {
        simulationContext.SelectedRoom = selectedRoom;
        PageRefresher.CallSHCTabRefreshRequested();
    }

    private bool AreLightsOn(IRoom room)
    {
        foreach (SmartLight light in room.Lights)
        {
            if (light.isOn)
                return true;
        }
        return false;
    }

    private bool AreWindowsOpen(IRoom room)
    {
        SmartWindow window = (SmartWindow)room.BottomWall.Window;

        if (window != null)
        {

            if (window.isOpen)
            {
                return true;
            }

        }

        window = (SmartWindow)room.LeftWall.Window;

        if (window != null)
        {

            if (window.isOpen)
            {
                return true;
            }

        }

        window = (SmartWindow)room.RightWall.Window;

        if (window != null)
        {

            if (window.isOpen)
            {
                return true;
            }

        }

        window = (SmartWindow)room.TopWall.Window;

        if (window != null)
        {

            if (window.isOpen)
            {
                return true;
            }

        }

        return false;

    }

    private bool AreDoorsLocked(IRoom room)
    {
        SmartDoor door = (SmartDoor)room.BottomWall.Door;

        if (door != null)
        {

            if (door.IsLocked)
            {
                return true;
            }

        }

        door = (SmartDoor)room.LeftWall.Door;

        if (door != null)
        {

            if (door.IsLocked)
            {
                return true;
            }

        }

        door = (SmartDoor)room.RightWall.Door;

        if (door != null)
        {

            if (door.IsLocked)
            {
                return true;
            }

        }

        door = (SmartDoor)room.TopWall.Door;

        if (door != null)
        {

            if (door.IsLocked)
            {
                return true;
            }

        }

        return false;

    }
    

}
